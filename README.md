# opendronemap-ecs
Serverless API to get opendronemap tasks running on AWS Elastic Container, with input files copied in from and output files copied back out to Simple Storage Service (S3).

## Note
STILL IN DEVELOPMENT

## Requirements
1. Configure an autoscaling launch configuration through the AWS EC2 console. Go to your desired region and scroll the left nav down to find 'AUTO SCALING'>'Launch Configurations' then select 'Create Launch Configuration'
    * __Step 1: Choose AMI__ - Under the AWS Marketplace tab, search for "ECS" to find the Amazon ECS-Optimized Amazon Linux AMI. A list of current AMI IDs for ECS AMIs by region can be found [here](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html).
    * __Step 2: Choose Instance Type__ - I recommend r4.4xlarge and the memory setting in [odm-task-definition.json](odm-task-definition.json) is geared for that.
    * __Step 3: Configure Details__ - Enter a name of your choice, review other settings, make sure the IAM role has access to your s3 bucket ([example policy you can attach](example-s3-policy.json)), and under 'Advanced Details' for 'User data' enter [user-data.yml](user-data.yml).
    * __Step 4: Add storage__ -
    * __Step 5: Configure security group__ - Select a security group (needs to be the same as the security group used at step 1).

2. Launch an autoscaling cluster using the new configuration. At the end of step 1 select 'Create an Auto Scaling group using this launch configuration' or go to your desired region and scroll the left nav down to find 'AUTO SCALING'>'Auto Scaling Groups' then select 'Create Auto Scaling group' then choose 'Create an Auto Scaling group from an existing launch configuration' and select the launch configuration from step 1.
    * __Step 1: Configure Auto Scaling group details__
        * __Group name__ -
        * __Group size__ -
        * __Network__ & __Subnet__ -
    * __Step 2. Configure scaling policies__ - I recommend one based on average CPU to start / terminate instances based on demand, as ODM is a CPU intensive task.
        * __Scale between X and Y instances__ -
        * __Target value:__ -

3. Install [serverless](https://serverless.com):
```shell
npm i -g serverless
```

See the [serverless quick start](https://serverless.com/framework/docs/providers/aws/guide/quick-start/) for more details on getting set up with serverless.

4. Once serverless is set up, edit [serverless.yml](serverless.yml) with your custom settings as needed, you can then deploy the service by running:
```shell
serverless deploy
```
This will return the URLs that you can then use to interact with the API you then set up custom domain with TLS in AWS web console for API Gateway or using the AWS CLI tool. For example:
```shell
Serverless: Stack update finished...
Service Information
service: odm
stage: prod
region: us-east-1
stack: odm-prod
api keys:
  None
endpoints:
  POST - https://abc123.execute-api.us-east-1.amazonaws.com/prod/run
  POST - https://abc123.execute-api.us-east-1.amazonaws.com/prod/register
functions:
  run: odm-prod-run
  register: odm-prod-register
```

# API
* The /register API that takes a json task definition like [[odm-task-definition.json](odm-task-definition.json) as the PUT body needs only be run once, or if you want to re-configure the task, noting that it's versioned and you will need to update the version in run.js and redeploy, noting you can run `serverless deploy function --function run` to update just the run function.
* The /run API runs an ODM task on the cluster, see [example-run-body.json](example-run-body.json) for an example.

# Debugging
To view the logs for the API go to the AWS console, select the region you deployed to (per serverless.yml), select Lambda, and then look for the deployed function named opendronemap-ecs-prod-run (unless you changed the service, stage and/or function name lines in serverless.yml), then click on monitoring, click on jump to logs, and select an appropriate time range in the CloudWatch logs.

# Web
* There's a basic web page for submitting jobs under [web/](web/) that you could host somewhere, after first replacing the API URL with the API URL generated by `serverless deploy`.
* On the to-do list is some web work to support S3 uploads. For now, I recommend an s3 client like (cross-platform) [CyberDuck](https://cyberduck.io/) or (macOS only) [ForkLift](https://www.binarynights.com/forklift/)

# opendronemap-ecs
Serverless API to get opendronemap tasks running on AWS Elastic Container, with input files copied in from and output files copied back out to Simple Storage Service (S3).

## Note
STILL IN DEVELOPMENT

## Requirements
1. Configure an autoscaling launch configuration through the AWS EC2 console:
    1. At the choose AMI step, select the ECS AMI for your AWS region from  , and under the AWS  marketplace tab, search for "ECS" to find the relevant AMI (a list of current AMI IDs for ECS AMIs can be found [here](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html)).
    2. Choose an instance typeâ€”I recommend r4.4xlarge (and the memory setting in [odm-task-definition.json](odm-task-definition.json) is geared for that).
    3. Under configure details, enter a name of your choice, review other settings, make sure the IAM role has access to your s3 bucket ([example policy you can attach](example-s3-policy.json)), and under advanced settings enter the user data from [user-data.yml](user-data.yml).
    4. Select a security group (needs to be the same as the security group used at step 1).
    
2. Launch an autoscaling cluster using that new configuration. Under scaling policies I recommend one based on average CPU to start / terminate instances based on demand, as ODM is a CPU intensive task.

3. Install [serverless](https://serverless.com):
```shell
npm i -g serverless
```
See the [serverless quick start](https://serverless.com/framework/docs/providers/aws/guide/quick-start/) for more details on getting set up with serverless.

4. Once serverless is set up, you can then deploy the service by running
```shell
serverless deploy
```

This will return the URLs that you can then use to interact with the API you then set up custom domain with TLS in AWS web console for API Gateway or using the AWS CLI tool.

# API
* The /register API that takes a json task definition like [[odm-task-definition.json](odm-task-definition.json) as the PUT body needs only be run once, or if you want to re-configure the task, noting that it's versioned and you will need to update the version in run.js and redeploy, noting you can run `serverless deploy function --function run` to update just the run function.
* The /run API runs an ODM task on the cluster, see [example-run-body.json](example-run-body.json) for an example.

# Web
There's a basic web page for submitting jobs under [web/](web/) that you could host somewhere, after first replacing the API URL with the API URL generated by `serverless deploy`. On the to-do list is some web work to support S3 uploads. For now, I recommend an s3 client like (cross-platform) [CyberDuck](https://cyberduck.io/) or (macOS only) [ForkLift](https://www.binarynights.com/forklift/)
